# Session Plan - December 29, 2025

## Overview
Continue database synchronization work and complete Phase 5 custom domain configuration.

---

## 1. Complete Database Synchronization

### Current Status

**Dev Azure Database (`traccems-dev-pgsql`):**
- ✅ Users: 12 (2 Center, 6 Healthcare, 4 EMS)
- ✅ EMS Agencies: 7
- ✅ Hospitals: 2
- ✅ Facilities: 2
- ✅ Healthcare Locations: 9
- ✅ Dropdown Categories: 7
- ✅ Dropdown Options: 62
- ✅ Pickup Locations: 26
- ⏳ Transport Requests: 37 (needs sync)
- ⏳ Trips: Unknown count (needs sync)
- ⏳ Other related data (needs verification)

**Local Dev Database (`medport_ems`):**
- ✅ Users: 12 synced
- ✅ EMS Agencies: 7 synced
- ✅ Hospitals: 2 synced
- ✅ Facilities: 2 synced
- ✅ Healthcare Locations: 9 synced
- ✅ Dropdown Categories: 7 synced
- ✅ Dropdown Options: 62 synced
- ✅ Pickup Locations: 26 synced
- ❌ Transport Requests: 0 (needs sync)
- ❌ Trips: 0 (needs sync)

**Production Azure Database (`traccems-prod-pgsql`):**
- ✅ Center Users: 1 (admin@tcc.com created manually)
- ❌ Healthcare Users: 0 (needs sync)
- ❌ EMS Users: 0 (needs sync)
- ❌ EMS Agencies: 0 (needs sync)
- ❌ Hospitals: 0 (needs sync)
- ❌ Facilities: 0 (needs sync)
- ❌ Healthcare Locations: 0 (needs sync)
- ❌ Dropdown Categories: 0 (needs sync)
- ❌ Dropdown Options: 0 (needs sync)
- ❌ Pickup Locations: 0 (needs sync)
- ❌ Transport Requests: 0 (needs sync)
- ❌ Trips: 0 (needs sync)

### Tasks

1. **Create sync script for Transport Requests**
   - Script: `backend/sync-transport-requests.js`
   - Sync from Dev Azure → Local Dev
   - Sync from Dev Azure → Production
   - Handle foreign key relationships (users, hospitals, facilities, etc.)

2. **Create sync script for Trips**
   - Script: `backend/sync-trips.js`
   - Sync from Dev Azure → Local Dev
   - Sync from Dev Azure → Production
   - Handle complex relationships (transport requests, pickup locations, EMS agencies, etc.)

3. **Verify and sync any remaining data**
   - Check for other tables that need syncing
   - Verify all foreign key relationships are preserved
   - Test data integrity after sync

4. **Complete three-way database sync**
   - Ensure Dev Azure, Local Dev, and Production all have matching data
   - Verify all users can log in across all environments
   - Test critical workflows in each environment

### Sync Scripts Already Created

- ✅ `backend/sync-users-across-environments.js` - Users sync
- ✅ `backend/sync-reference-data.js` - Hospitals, facilities, healthcare locations
- ✅ `backend/sync-dropdown-and-pickup-data.js` - Dropdown categories/options, pickup locations
- ✅ `backend/sync-full-database.js` - Comprehensive sync utility (may need updates)
- ✅ `backend/create-prod-admin.js` - Production admin user creation

### Sync Scripts Needed

- ⏳ `backend/sync-transport-requests.js` - Transport requests sync
- ⏳ `backend/sync-trips.js` - Trips sync
- ⏳ `backend/sync-all-data.js` - Master sync script that runs all syncs in order

---

## 2. Phase 5 Custom Domain - SSL Certificate Status

### Current Status

**Phase 5.1:** ✅ COMPLETE - Frontend custom domain (`traccems.com`) configured
**Phase 5.2:** ✅ COMPLETE - Backend custom domain (`api.traccems.com`) configured, SSL certificate bound
**Phase 5.3:** ✅ COMPLETE - Frontend API configuration updated
**Phase 5.4:** ✅ COMPLETE - Backend CORS configuration updated, Easy Auth disabled, login working

### SSL Certificate Status Check

**Task:** Verify SSL certificate provisioning status for `api.traccems.com`

**Commands to run:**
```bash
# Check SSL certificate status
curl -I https://api.traccems.com/health

# Check Azure Portal status
az webapp config hostname list --webapp-name TraccEms-Prod-Backend \
  --resource-group TraccEms-Prod-USCentral \
  --query "[?hostname=='api.traccems.com'].{hostname:hostname,sslState:sslState}"

# Alternative: Check via Azure Portal
# Azure Portal → TraccEms-Prod-Backend → Custom domains
# Look for SSL certificate status for api.traccems.com
```

**Expected Status:**
- If SSL is provisioned: `curl` should return HTTP 200 with valid certificate
- If still provisioning: `curl` will fail with SSL certificate error (exit code 60)

**If SSL is Ready:**
- Proceed to Phase 5.4 (CORS configuration)
- Test full end-to-end flow: Frontend → Backend via custom domains

**If SSL Still Provisioning:**
- Note current status
- Can proceed with Phase 5.4 (CORS update) in parallel (won't affect SSL provisioning)
- Continue monitoring SSL status

---

## 3. Phase 5.4: Update Backend CORS Configuration

### Task: Update CORS Settings for Custom Domain

**Reference:** `docs/reference/azure/phase5-custom-domain-guide.md` (Task 5.4)

**Steps:**

1. **Check Current CORS Configuration**
   ```bash
   az webapp config appsettings list \
     --name TraccEms-Prod-Backend \
     --resource-group TraccEms-Prod-USCentral \
     --query "[?name=='CORS_ORIGIN' || name=='FRONTEND_URL']"
   ```

2. **Update CORS_ORIGIN Environment Variable**
   ```bash
   az webapp config appsettings set \
     --name TraccEms-Prod-Backend \
     --resource-group TraccEms-Prod-USCentral \
     --settings CORS_ORIGIN="https://traccems.com"
   ```

3. **Update FRONTEND_URL Environment Variable**
   ```bash
   az webapp config appsettings set \
     --name TraccEms-Prod-Backend \
     --resource-group TraccEms-Prod-USCentral \
     --settings FRONTEND_URL="https://traccems.com"
   ```

4. **Restart App Service** (if needed)
   ```bash
   az webapp restart \
     --name TraccEms-Prod-Backend \
     --resource-group TraccEms-Prod-USCentral
   ```

5. **Verify CORS Configuration**
   - Test API call from `https://traccems.com` to `https://api.traccems.com`
   - Check browser console for CORS errors
   - Verify preflight OPTIONS requests succeed

---

## 4. Testing & Verification

### Database Sync Verification

1. **Verify User Counts Match**
   - Dev Azure: 12 users
   - Local Dev: 12 users
   - Production: 12 users (after sync)

2. **Verify Data Integrity**
   - Test login with same credentials across all environments
   - Verify relationships are preserved (users → agencies, users → facilities, etc.)
   - Check that foreign keys are valid

3. **Test Critical Workflows**
   - Create transport request (if applicable)
   - Create trip (if applicable)
   - Verify data appears correctly in all environments

### Custom Domain Verification

1. **Frontend Verification**
   - ✅ `https://traccems.com` loads correctly
   - ✅ SSL certificate valid (green lock)
   - ✅ Frontend console shows API URL: `https://api.traccems.com`

2. **Backend Verification**
   - ⏳ `https://api.traccems.com/health` returns `{"status":"healthy"}`
   - ⏳ SSL certificate valid
   - ⏳ CORS allows requests from `https://traccems.com`

3. **End-to-End Verification**
   - Login flow works via custom domains
   - API calls succeed without CORS errors
   - Full application functionality works

---

## 5. Documentation Updates

### Files to Update

1. **`docs/reference/azure/phase5-custom-domain-guide.md`**
   - Update Phase 5.2 status (SSL certificate)
   - Update Phase 5.4 status (CORS configuration)
   - Add technical notes for any issues encountered

2. **`docs/reference/current_credentials_2025_12_27.md`**
   - Update sync status for all three environments
   - Document any new credentials or changes

3. **Create sync documentation** (if needed)
   - Document sync process and scripts
   - Add troubleshooting guide for sync issues

---

## 6. Next Steps After Completion

1. **Production Testing**
   - Test full application on production custom domains
   - Verify all features work correctly
   - Monitor for any issues

2. **Monitoring**
   - Monitor SSL certificate status
   - Monitor CORS errors in production
   - Monitor database sync status

3. **Future Enhancements**
   - Consider automating database syncs
   - Consider adding sync verification scripts
   - Consider adding monitoring/alerting for sync status

---

## Quick Reference Commands

### Database Sync
```bash
# Sync users
SOURCE_DB="postgresql://traccems_admin:password1!@traccems-dev-pgsql.postgres.database.azure.com:5432/postgres?sslmode=require" \
TARGET_DB="postgresql://scooper@localhost:5432/medport_ems?schema=public" \
node backend/sync-users-across-environments.js sync

# Sync reference data
SOURCE_DB="postgresql://traccems_admin:password1!@traccems-dev-pgsql.postgres.database.azure.com:5432/postgres?sslmode=require" \
TARGET_DB="postgresql://scooper@localhost:5432/medport_ems?schema=public" \
node backend/sync-reference-data.js

# Sync dropdown and pickup data
SOURCE_DB="postgresql://traccems_admin:password1!@traccems-dev-pgsql.postgres.database.azure.com:5432/postgres?sslmode=require" \
TARGET_DB="postgresql://scooper@localhost:5432/medport_ems?schema=public" \
node backend/sync-dropdown-and-pickup-data.js
```

### SSL Status Check
```bash
curl -I https://api.traccems.com/health
```

### CORS Configuration
```bash
az webapp config appsettings set \
  --name TraccEms-Prod-Backend \
  --resource-group TraccEms-Prod-USCentral \
  --settings CORS_ORIGIN="https://traccems.com" FRONTEND_URL="https://traccems.com"
```

---

## Notes

- All sync scripts preserve password hashes (users keep their passwords)
- Sync scripts handle foreign key relationships
- Sync scripts skip deleted records (`isDeleted = true`)
- Production database currently has minimal data (only admin user)
- SSL certificate provisioning can take up to 24 hours
- CORS configuration can be updated before SSL is ready

---

**Created:** December 28, 2025  
**Last Updated:** December 28, 2025  
**Status:** Ready to Begin

