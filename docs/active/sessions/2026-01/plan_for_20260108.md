# Production Trip Display Issues - Troubleshooting Plan
**Date:** January 8, 2026  
**Status:** üü° **FIXES APPLIED** - Awaiting Testing  
**Session Focus:** Troubleshooting production trip display and agency response issues

---

## Session Context

### Recent Work Completed (January 7, 2026)
- ‚úÖ Backend rollback to working state (commit `bd86de5f`)
- ‚úÖ Database alignment work (added missing `trips` table columns)
- ‚úÖ Created `agency_responses` table in production
- ‚úÖ Fixed orphaned EMS agency issue (`chuck@chuckambulance.com`)
- ‚úÖ Production database backup added to backup strategy
- ‚úÖ Backend running successfully in production
- ‚úÖ Login working for `admin@tcc.com`

### Current Production State
- **Backend:** ‚úÖ Running (deployment 51)
- **Database:** ‚úÖ Synchronized (trips table has 63 columns)
- **Login:** ‚úÖ Working (`admin@tcc.com`, `chuck@chuckambulance.com`)
- **Backend Health:** ‚úÖ Responding (`https://api.traccems.com/health`)

---

## Production Issues Identified

### Issue 1: EMS Dashboard - "Failed to fetch agency responses" Error

**User:** `chuck@chuckambulance.com` (EMS login)  
**Location:** EMS Dashboard ‚Üí "Available Trips" tab  
**Error:** "Failed to fetch agency responses"  
**Status:** üî¥ **BLOCKING**

**Trip Details:**
- **Patient ID:** PJZQ4VEW6
- **Requested Pickup Time:** 01/07/2026, 10:34:00 PM
- **Route:** Penn Highlands Brookville ‚Üí Penn Highlands DuBois
- **Transport Level:** BLS
- **Ticket Created At:** 01/07/2026, 05:35:32 PM
- **Facility:** Penn Highlands Brookville
- **Pickup Location:** Emergency Department ‚Ä¢ ((814) 849-1852)

**Observations:**
- ‚úÖ Trip successfully created and dispatched
- ‚úÖ Trip displays in TCC Command module
- ‚ùå EMS dashboard shows error when loading "Available Trips"
- ‚ùå Error specifically mentions "Failed to fetch agency responses"

**Expected Behavior:**
- EMS dashboard should load available trips (PENDING status)
- Should fetch agency responses for the logged-in agency
- Should display trips that haven't been responded to yet

**Technical Context:**
- Frontend code: `EMSDashboard.tsx` line 215 - `GET /api/agency-responses?agencyId=${currentAgencyId}`
- Backend route: `backend/src/routes/agencyResponses.ts` - `GET /api/agency-responses`
- Backend service: `backend/src/services/tripService.ts` - `getAgencyResponses()`
- Database table: `agency_responses` (created January 7, 2026)

---

### Issue 2: Healthcare Dashboard - Missing Trip in Transport Requests

**User:** `test-healthcare@tcc.com` (Healthcare login)  
**Location:** Healthcare Dashboard ‚Üí "Transport Requests" list  
**Error:** Trip not visible in list  
**Status:** ‚úÖ **FIXED** (January 8, 2026)

**Observations:**
- ‚úÖ Trip successfully created
- ‚úÖ Trip displays in TCC Command module
- ‚ùå Trip missing from Healthcare Dashboard "Transport Requests" list
- ‚ùå Healthcare user cannot see their own created trip

**Expected Behavior:**
- Healthcare dashboard should show all trips created by healthcare users
- Should filter by `healthcareUserId` or show all trips for the facility
- Should display trip status and details

**Root Cause Identified:**
The filtering logic in `tripService.getTrips()` had a flaw when handling healthcare users with multiple locations:
1. For multi-location users, the filter used: `{ fromLocationId: { in: locationIds } } OR { healthcareCreatedById: userId }`
2. However, if a trip was created by the user but the `fromLocationId` didn't match any of the user's locations AND there was an existing OR condition from other filters, the filter combination could fail
3. The filter didn't prioritize trips created by the user - it treated location matching and creator matching equally, which could cause issues when combining with other filters

**Fix Applied:**
Updated `backend/src/services/tripService.ts` (lines 182-236):
- **Always prioritize trips created by the user**: The filter now ALWAYS includes `{ healthcareCreatedById: filters.healthcareUserId }` as the first condition, ensuring trips created by the user always appear
- **Proper filter combination**: Fixed the logic to properly combine healthcare user filters with existing OR conditions (e.g., from status filters) using AND logic
- **Better error handling**: Improved fallback logic when location queries fail

**Technical Context:**
- Frontend code: `HealthcareDashboard.tsx` line 180 - `GET /api/trips`
- Backend route: `backend/src/routes/trips.ts` - `GET /api/trips` (line 274 passes `healthcareUserId`)
- Backend service: `backend/src/services/tripService.ts` - `getTrips()` (lines 182-236 - FIXED)
- Database tables: `transport_requests`, `trips`

---

## Investigation Plan

### Step 1: Create Git Branch for Fixes

**Action:** Create a new feature branch for troubleshooting and fixes

```bash
git checkout -b fix/production-trip-display-issues
```

**Rationale:** 
- Isolate fixes from main branch
- Allow testing before merging
- Follow user's preference for feature branches

---

### Step 2: Verify Database State

**Check Production Database:**

1. **Verify trip exists:**
   ```sql
   SELECT * FROM transport_requests WHERE "patientId" = 'PJZQ4VEW6';
   SELECT * FROM trips WHERE "patientId" = 'PJZQ4VEW6';
   ```

2. **Verify agency_responses table:**
   ```sql
   SELECT COUNT(*) FROM agency_responses;
   SELECT * FROM agency_responses WHERE "tripId" = '<trip-id>';
   ```

3. **Verify EMS user/agency linkage:**
   ```sql
   SELECT * FROM ems_users WHERE email = 'chuck@chuckambulance.com';
   SELECT * FROM ems_agencies WHERE id = '<agency-id>';
   ```

4. **Verify healthcare user:**
   ```sql
   SELECT * FROM healthcare_users WHERE email = 'test-healthcare@tcc.com';
   ```

**Expected Findings:**
- Trip should exist in `transport_requests` table
- Trip may or may not exist in `trips` table (depending on workflow)
- `agency_responses` table should exist (created January 7)
- EMS user should be linked to correct agency
- Healthcare user should exist

---

### Step 3: Check Backend Logs

**Action:** Review Azure App Service logs for errors

**Check for:**
- API errors when fetching `/api/agency-responses`
- API errors when fetching `/api/trips`
- Database connection errors
- Prisma query errors
- Authentication/authorization errors

**Log Location:** Azure Portal ‚Üí TraccEms-Prod-Backend ‚Üí Log Stream

**Key Error Patterns to Look For:**
- `Failed to fetch agency responses`
- `column does not exist`
- `relation does not exist`
- `permission denied`
- `ECONNREFUSED`
- `P2002` (unique constraint)
- `P2025` (record not found)

---

### Step 4: Test API Endpoints Directly

**Test Agency Responses Endpoint:**

```bash
# Test with EMS user token
curl -H "Authorization: Bearer <ems-token>" \
  "https://api.traccems.com/api/agency-responses?agencyId=<agency-id>"

# Test without agencyId (should auto-filter for EMS user)
curl -H "Authorization: Bearer <ems-token>" \
  "https://api.traccems.com/api/agency-responses"
```

**Test Trips Endpoint:**

```bash
# Test with healthcare user token
curl -H "Authorization: Bearer <healthcare-token>" \
  "https://api.traccems.com/api/trips"

# Test with admin token
curl -H "Authorization: Bearer <admin-token>" \
  "https://api.traccems.com/api/trips"
```

**Expected Results:**
- Agency responses endpoint should return empty array `[]` if no responses exist
- Trips endpoint should return trip data including the created trip
- Both should return `200 OK` status

---

### Step 5: Verify Frontend-Backend Communication

**Check Browser Console:**
- Open browser DevTools ‚Üí Network tab
- Navigate to EMS Dashboard ‚Üí Available Trips
- Check failed requests:
  - Request URL
  - Request headers (Authorization token)
  - Response status code
  - Response body (error message)

**Check Frontend Code:**
- Verify `EMSDashboard.tsx` is calling correct endpoint
- Verify error handling is displaying correct error message
- Verify `agencyId` is being passed correctly

---

## Potential Root Causes

### Hypothesis 1: Agency Responses Query Failing
**Possible Causes:**
- `agency_responses` table exists but query is failing
- Missing foreign key relationships
- Prisma client not regenerated after table creation
- Query filters not working correctly

**Investigation:**
- Check if `agency_responses` table has correct schema
- Verify Prisma schema matches database
- Test Prisma query directly in backend code

### Hypothesis 2: Trip Not Linked to Healthcare User
**Possible Causes:**
- `healthcareUserId` not set when trip created
- Trip created with wrong user ID
- Filter query excluding this trip
- Trip in wrong status (not showing in Transport Requests)

**Investigation:**
- Check `transport_requests.healthcareUserId` field
- Verify healthcare user ID matches logged-in user
- Check trip status (should be visible in Transport Requests)

### Hypothesis 3: Authentication/Authorization Issue
**Possible Causes:**
- Token not including correct user type
- Backend not recognizing EMS/Healthcare user type
- Authorization middleware blocking requests
- User not properly linked to agency/facility

**Investigation:**
- Verify JWT token payload
- Check backend authentication middleware
- Verify user type in database matches token

### Hypothesis 4: Database Schema Mismatch
**Possible Causes:**
- Missing columns in `transport_requests` or `trips` tables
- Foreign key constraints missing
- Indexes missing causing slow queries
- Prisma schema out of sync with database

**Investigation:**
- Compare production schema to `schema.prisma`
- Check for missing columns/relationships
- Verify all migrations applied

---

## Fix Strategy

### Phase 1: Diagnosis (This Session)
1. ‚úÖ Create git branch
2. ‚úÖ Verify database state
3. ‚úÖ Check backend logs
4. ‚úÖ Test API endpoints
5. ‚úÖ Identify root cause(s)

### Phase 2: Fixes (Next Steps)
1. ‚è≠Ô∏è Fix identified issues
2. ‚è≠Ô∏è Test fixes locally (if possible)
3. ‚è≠Ô∏è Deploy to production
4. ‚è≠Ô∏è Verify fixes work
5. ‚è≠Ô∏è Merge to main branch
6. ‚è≠Ô∏è Sync main ‚Üí develop (keep dev-swa in sync)

---

## Production Fix Workflow: Keeping All Environments in Sync

**Scenario:** Issue found in production that works in local dev - how to fix while keeping all three environments synchronized.

### Overview: Three Environments

| Environment | Frontend URL | Backend URL | Database | Purpose |
|------------|--------------|-------------|----------|---------|
| **Local Dev** | `http://localhost:3000` | `http://localhost:5001` | `medport_ems` (local PostgreSQL) | Development & Testing |
| **Dev-SWA** | `https://dev-swa.traccems.com` | `https://dev-api.traccems.com` | `traccems-dev-pgsql` (Azure Dev) | Staging/Testing |
| **Production** | `https://traccems.com` | `https://api.traccems.com` | `traccems-prod-pgsql` (Azure Prod) | Live Client Use |

---

### Step-by-Step Workflow

#### Step 1: Create Fix Branch

```bash
# Start from main branch
git checkout main
git pull origin main

# Create feature branch for the fix
git checkout -b fix/production-issue-description
```

**Rationale:** 
- Isolate fixes from main branch
- Allow testing before merging
- Follow user's preference for feature branches

---

#### Step 2: Investigate and Fix in Local Dev

**"Locally" means your Local Dev environment:**
- Frontend: `http://localhost:3000`
- Backend: `http://localhost:5001`
- Database: Local PostgreSQL (`medport_ems`)

**Process:**
1. **Reproduce the issue locally** (if possible)
   - Set up similar data conditions
   - Test the same user flow
   - Verify the issue exists or doesn't exist locally

2. **Make the fix**
   - Edit code in your local workspace
   - Test the fix in local dev environment
   - Verify the fix resolves the issue

3. **Commit the fix:**
   ```bash
   git add .
   git commit -m "Fix: [description of the issue]"
   ```

**Note:** If the issue can't be reproduced locally (e.g., production-specific data or environment differences), you may need to:
- Fix based on production logs/errors
- Test the fix logic in local dev with similar scenarios
- Deploy to production and verify there

---

#### Step 3: Merge to Main and Deploy to Production

```bash
# Merge fix to main
git checkout main
git merge fix/production-issue-description
git push origin main
```

**Deploy via GitHub Actions:**

1. **Frontend Deployment** (if frontend changed):
   - Go to: GitHub Actions ‚Üí "production - Deploy Prod Frontend"
   - Click "Run workflow"
   - Select branch: `main`
   - Click "Run workflow"
   - Frontend deploys to `https://traccems.com`

2. **Backend Deployment** (if backend changed):
   - Go to: GitHub Actions ‚Üí "production - Deploy Prod Backend"
   - Click "Run workflow"
   - Select branch: `main`
   - Click "Run workflow"
   - Backend deploys to `https://api.traccems.com`
   - **Note:** Backend deployment runs Prisma migrations automatically if schema changed

**When Backend MUST Be Deployed:**
- Database schema changes (Prisma migrations)
- Backend code changes (API endpoints, services, middleware)
- Environment variable changes (requires App Service restart)

**When Backend Does NOT Need Deployment:**
- Frontend-only changes
- Documentation changes
- Configuration changes (Azure Portal)

---

#### Step 4: Sync Main ‚Üí Develop (CRITICAL)

**‚ö†Ô∏è ALWAYS sync after production fixes to keep dev-swa in sync**

**Option 1: Use Sync Script (Recommended)**
```bash
./scripts/sync-main-to-develop.sh
```

This script:
- Checks if main has commits not in develop
- Merges main ‚Üí develop automatically
- Pushes develop (triggers dev-swa deployment)
- Returns you to your original branch

**Option 2: Manual Sync**
```bash
# Make sure main is up to date
git checkout main
git pull origin main

# Merge main into develop to sync fixes
git checkout develop
git pull origin develop
git merge main --no-edit

# Push develop to trigger dev-swa deployment
git push origin develop
```

**Why This Is Critical:**
- Dev-swa auto-deploys from `develop` branch
- Without syncing, dev-swa will be missing production fixes
- You'd have to fix the same issue twice
- Environments get out of sync

---

#### Step 5: Update Local Dev

```bash
# Pull the latest from main or develop
git checkout main  # or develop
git pull origin main  # or origin develop
```

Now your local dev environment has the fix and matches production/dev-swa.

---

### Complete Workflow Summary

```
1. Create fix branch (from main)
   ‚Üì
2. Fix in Local Dev (localhost:3000/5001)
   ‚Üì
3. Test locally
   ‚Üì
4. Merge to main ‚Üí Deploy to Production
   ‚Üì
5. Sync main ‚Üí develop (CRITICAL!)
   ‚Üì
6. Dev-swa auto-deploys (from develop push)
   ‚Üì
7. Update local dev (pull from main/develop)
   ‚Üì
‚úÖ All three environments now in sync
```

---

### Quick Reference Commands

```bash
# Complete workflow (after fixing locally)
git checkout main
git merge fix/production-issue-description
git push origin main
# Deploy via GitHub Actions (frontend/backend as needed)
./scripts/sync-main-to-develop.sh  # Sync to dev-swa
git checkout main && git pull origin main  # Update local dev
```

---

### Important Notes

1. **Always sync after production fixes:** After deploying to production, sync main ‚Üí develop so dev-swa stays aligned.

2. **Database changes:** If fix includes database migrations, ensure migrations run in production during backend deployment.

3. **Test in dev-swa:** After syncing, verify the fix works in dev-swa before considering it complete.

4. **Local dev:** Pull from main or develop to get the fix locally.

5. **Emergency hotfixes:** If fixing production directly on main (emergency), still follow Step 4 to sync back to develop.

---

## Key Files to Review

### Backend Files:
- `backend/src/routes/agencyResponses.ts` - Agency responses API route
- `backend/src/routes/trips.ts` - Trips API route
- `backend/src/services/tripService.ts` - Trip service logic
- `backend/prisma/schema.prisma` - Database schema

### Frontend Files:
- `frontend/src/components/EMSDashboard.tsx` - EMS dashboard component
- `frontend/src/components/HealthcareDashboard.tsx` - Healthcare dashboard component
- `frontend/src/components/TripsView.tsx` - Trips view component

### Database:
- `agency_responses` table structure
- `transport_requests` table structure
- `trips` table structure
- Foreign key relationships

---

## Testing Checklist

### After Fixes Applied:
- [ ] EMS user can see "Available Trips" without errors
- [ ] Healthcare user can see created trip in "Transport Requests"
- [ ] Agency responses endpoint returns correct data
- [ ] Trips endpoint returns correct data
- [ ] No console errors in browser
- [ ] No errors in backend logs
- [ ] Trip displays correctly in TCC Command module (still works)

---

## Notes and Observations

### Database Alignment Status:
- ‚úÖ `trips` table has 63 columns (aligned with schema)
- ‚úÖ `agency_responses` table created (January 7, 2026)
- ‚ö†Ô∏è May need to verify all relationships exist
- ‚ö†Ô∏è May need to verify all indexes exist

### Recent Fixes Applied:
- ‚úÖ Created `agency_responses` table
- ‚úÖ Fixed orphaned EMS agency
- ‚úÖ Added missing `trips` columns
- ‚ö†Ô∏è May need to verify Prisma client regenerated

### Production Environment:
- **Backend URL:** `https://api.traccems.com`
- **Frontend URL:** `https://traccems.com`
- **Database:** `traccems-prod-pgsql.postgres.database.azure.com`
- **Backend Status:** Running (deployment 51)

---

## Session Goals

1. **Identify Root Causes:** Determine why agency responses fail and trip is missing
2. **Fix Issues:** Apply fixes to resolve both problems
3. **Verify Fixes:** Test that both EMS and Healthcare dashboards work correctly
4. **Document Solutions:** Update documentation with fixes applied

---

## Quick Start Commands

```bash
# 1. Create feature branch
git checkout -b fix/production-trip-display-issues

# 2. Check current commit
git log --oneline -1

# 3. Verify backend health
curl https://api.traccems.com/health

# 4. Check database connection (if pgAdmin configured)
# Connect to production database and run queries above
```

---

## Fixes Applied (January 8, 2026)

### ‚úÖ Fix 1: Transport Request Display Issue (Healthcare Dashboard)
**Status:** Fixed - Awaiting Testing

**Root Cause:** Filtering logic in `tripService.getTrips()` had issues when combining healthcare user filters with other filters. The OR condition wasn't being properly combined with existing filters.

**Changes:**
- `backend/src/services/tripService.ts` (lines 182-236):
  - Always prioritize trips created by the user (`healthcareCreatedById` check first)
  - Properly combine healthcare user filters with existing OR conditions using AND logic
  - Added comprehensive diagnostic logging

**Files Modified:**
- `backend/src/services/tripService.ts`
- `backend/src/routes/trips.ts` (added diagnostic logging)

---

### ‚úÖ Fix 2: TCC Command Trip Creation Issues
**Status:** Fixed - Awaiting Testing

**Issues Fixed:**
1. **Incomplete Destinations Dropdown** - Penn Highlands locations missing
2. **"Selected facility not found" Error** - Facility validation failing for TCC Command users
3. **Missing `destinationFacilityId`** - Not included in enhanced payload
4. **Auto-dispatch Workflow** - Not triggering after trip creation

**Changes:**
- `frontend/src/components/EnhancedTripForm.tsx`:
  - Added TCC Command branch in `loadFormOptions()` to load ALL healthcare locations for destinations
  - Fixed facility validation to check `tccHealthcareFacilities` for TCC Command users
  - Added `destinationFacilityId` to enhanced payload
  - Changed all users to use enhanced endpoint (not just healthcare users)
  - Fixed ID format consistency (removed `loc_` prefix)
  
- `frontend/src/components/TCCCreateTrip.tsx`:
  - Added auto-dispatch workflow (matches Healthcare module)
  - Opens `TripDispatchScreen` automatically after trip creation

**Files Modified:**
- `frontend/src/components/EnhancedTripForm.tsx`
- `frontend/src/components/TCCCreateTrip.tsx`

---

### ‚úÖ Fix 3: Backend Trip Creation - Set healthcareCreatedById from Location Owner
**Status:** Fixed - Awaiting Testing

**Issue:** When trips are created via TCC Command (without `healthcareUserId`), `healthcareCreatedById` was null, causing trips not to display for healthcare users.

**Fix:** When `fromLocationId` is provided but `healthcareUserId` is not, set `healthcareCreatedById` from the location's owner.

**Changes:**
- `backend/src/services/tripService.ts` (lines 982-1004):
  - When validating healthcare location, also fetch `healthcareUserId`
  - If `healthcareUserId` wasn't provided, set it from the location's owner

**Files Modified:**
- `backend/src/services/tripService.ts`

---

## Testing Checklist

### Transport Request Display (Healthcare Dashboard):
- [ ] Healthcare user can see trips they created in "Transport Requests" list
- [ ] Trips created via TCC Command appear for the correct healthcare user
- [ ] Filtering by status works correctly
- [ ] Multi-location users see trips from all their locations

### TCC Command Trip Creation:
- [ ] Destinations dropdown shows all Penn Highlands locations
- [ ] Destinations dropdown shows all healthcare locations
- [ ] Facility selection works without "Selected facility not found" error
- [ ] Trip creation succeeds without "Failed to create transport request" error
- [ ] Dispatch screen opens automatically after trip creation
- [ ] Dispatch workflow functions correctly

### Backend Logs (Check for):
- [ ] `TCC_DEBUG: Healthcare user requesting trips:` shows correct user ID
- [ ] `TCC_DEBUG: Final where clause:` shows correct filter logic
- [ ] `TCC_DEBUG: Found trips:` shows trips found (not 0)
- [ ] Diagnostic logs show trips exist and user locations are correct

---

**Last Updated:** January 8, 2026  
**Next Session:** January 8, 2026  
**Status:** üü° Fixes Applied - Awaiting Testing

