# Category Options Fix - Phase 3 & 4 Plan
**Date:** January 20, 2026  
**Status:** üìã **READY FOR PHASE 3** - Dev-SWA Migration  
**Branch:** `fix/category-options-hardcoded-slugs`  
**Previous Session:** January 19, 2026

---

## ‚úÖ Accomplishments from January 19, 2026

### Phase 1: Preparation & Branch Setup - ‚úÖ COMPLETE
- ‚úÖ Created git branch: `fix/category-options-hardcoded-slugs`
- ‚úÖ Created SQL documentation script: `backend/migrations/01-document-current-state.sql`
- ‚úÖ Created SQL migration script: `backend/migrations/02-category-slugs-to-dropdown-n.sql`
- ‚úÖ Documented current state: 7 categories, 62 options, no orphaned data

### Phase 2: Local Dev Implementation - ‚úÖ COMPLETE

**Database Migration:**
- ‚úÖ Executed migration script successfully on local dev database
- ‚úÖ All 7 categories renamed to `dropdown-1` through `dropdown-7`
- ‚úÖ All 62 options updated to use new category slugs
- ‚úÖ Verified no orphaned options

**Backend Code Changes:**
- ‚úÖ Updated `backend/prisma/seed.ts` - category slugs changed to dropdown-1 through dropdown-7
- ‚úÖ Updated `backend/src/routes/dropdownCategories.ts`:
  - POST endpoint disabled (returns 403)
  - PUT endpoint prevents slug changes
  - Only allows updating displayName, displayOrder, isActive
- ‚úÖ Updated `backend/src/routes/dropdownOptions.ts` - urgency references updated to dropdown-2

**Frontend Code Changes:**
- ‚úÖ Updated `frontend/src/components/HospitalSettings.tsx`:
  - Removed "Add Category" button
  - Slug field is read-only in edit form
  - Added message explaining categories are fixed
- ‚úÖ Updated `frontend/src/components/EnhancedTripForm.tsx`:
  - All category slugs updated to dropdown-1 through dropdown-7
  - Default option loading endpoints updated
- ‚úÖ Updated `frontend/src/services/api.ts` - documented category creation is disabled

**Testing:**
- ‚úÖ Category Options tab: All tests passed
  - 7 categories display correctly
  - Can edit display names and order
  - Cannot add new categories
  - Slug field is read-only
- ‚úÖ Trip Creation: All dropdowns load correctly
- ‚úÖ Trip Dispatch: Tested successfully (Patient P5H1DQKRU)

**Git & Backup:**
- ‚úÖ All changes committed to branch
- ‚úÖ Backup created to both `/Volumes/Acasis/` and iCloud Drive
- ‚úÖ Backup script created: `documentation/scripts/backup-to-both-locations.sh`

---

## üìã Phase 3: Dev-SWA Migration & Testing

### Prerequisites
- ‚úÖ Local dev testing passed
- ‚úÖ All code changes committed to branch
- ‚úÖ Migration script tested and verified

### Task 3.1: Database Migration (pgAdmin)
- [ ] **Create full database backup** for dev-swa using backup script
- [ ] Open pgAdmin
- [ ] Connect to dev-swa database (`traccems-dev-pgsql`)
- [ ] Open Query Tool
- [ ] Load and execute: `backend/migrations/02-category-slugs-to-dropdown-n.sql`
- [ ] Verify results:
  - [ ] 7 categories exist with slugs `dropdown-1` through `dropdown-7`
  - [ ] All options are linked to correct categories
  - [ ] No orphaned options
  - [ ] Category counts match expected values
- [ ] Test that existing trips still work (verify data integrity)

### Task 3.2: Code Deployment
- [ ] Ensure all changes are committed to branch `fix/category-options-hardcoded-slugs`
- [ ] Push branch to GitHub
- [ ] Merge branch to `develop` (or create PR and merge)
- [ ] Trigger dev-swa backend deployment
- [ ] Wait for deployment to complete
- [ ] Trigger dev-swa frontend deployment
- [ ] Wait for deployment to complete

### Task 3.3: Dev-SWA Testing
- [ ] Test Category Options tab:
  - [ ] Verify 7 categories display correctly (including special-needs)
  - [ ] Verify can edit display names
  - [ ] Verify can edit display order
  - [ ] Verify cannot add new category (button removed)
  - [ ] Verify cannot edit slugs (field removed)
- [ ] **Primary Test: Trip Creation Form**
  - [ ] Verify all 6 dropdowns load options correctly:
    - [ ] Transport Level (dropdown-1)
    - [ ] Urgency Level (dropdown-2)
    - [ ] Diagnosis (dropdown-3)
    - [ ] Mobility Level (dropdown-4)
    - [ ] Insurance Company (dropdown-5)
    - [ ] Secondary Insurance (dropdown-6)
  - [ ] Verify special-needs checkboxes load from dropdown-7
  - [ ] Create new trip with all fields populated
  - [ ] Verify trip saves successfully
- [ ] **Spot Check: EMS Providers**
  - [ ] Verify EMS Providers list loads
  - [ ] Verify no errors in console
- [ ] **Spot Check: Destinations**
  - [ ] Verify destination selection works
  - [ ] Verify no errors in console
- [ ] Test with existing data:
  - [ ] Verify existing trips display correctly
  - [ ] Verify existing options still work
- [ ] Check backend logs for any errors
- [ ] Verify no 500 errors in browser console

**If Issues Found:**
- [ ] Document the issue
- [ ] Fix in local dev first
- [ ] Re-test locally
- [ ] Re-deploy to dev-swa
- [ ] Re-test dev-swa

---

## üìã Phase 4: Production Migration & Deployment

### Prerequisites
- ‚úÖ Dev-SWA is stable (no errors for 24+ hours, or proceed if local dev went smoothly)
- ‚úÖ All testing passed in dev-swa

### Task 4.1: Pre-Production Checklist
- [ ] Verify dev-swa is stable
- [ ] **Create full production database backup** using backup script
- [ ] Document rollback plan
- [ ] Schedule maintenance window (if needed)

### Task 4.2: Database Migration (pgAdmin)
- [ ] **CRITICAL: Full production database backup already created** (from Task 4.1)
- [ ] Open pgAdmin
- [ ] Connect to production database (`traccems-prod-pgsql`)
- [ ] Open Query Tool
- [ ] Load and execute: `backend/migrations/02-category-slugs-to-dropdown-n.sql`
- [ ] Verify results (same checks as local dev):
  - [ ] 7 categories exist with slugs `dropdown-1` through `dropdown-7`
  - [ ] All options are linked to correct categories
  - [ ] No orphaned options
  - [ ] Category counts match expected values
- [ ] Test that existing production trips still work

### Task 4.3: Code Deployment
- [ ] Merge `develop` to `main` branch
- [ ] Trigger production backend deployment via GitHub Actions
- [ ] Monitor deployment logs
- [ ] Wait for deployment to complete
- [ ] Trigger production frontend deployment
- [ ] Monitor deployment logs
- [ ] Wait for deployment to complete

### Task 4.4: Production Verification
- [ ] Test Category Options tab (verify 7 categories display)
- [ ] **Primary Test: Trip Creation Form**
  - [ ] Verify all 6 dropdowns load options correctly
  - [ ] Verify special-needs checkboxes load
  - [ ] Create test trip with all fields populated
  - [ ] Verify trip saves successfully
- [ ] **Spot Check: EMS Providers**
  - [ ] Verify EMS Providers list loads
  - [ ] Verify no errors in console
- [ ] **Spot Check: Destinations**
  - [ ] Verify destination selection works
  - [ ] Verify no errors in console
- [ ] Test with existing production data (verify existing trips display correctly)
- [ ] Monitor backend logs for errors
- [ ] Check Azure Portal for any alerts
- [ ] Verify no user-reported issues

**If Production Issues:**
- [ ] Immediately assess severity
- [ ] If critical: Execute rollback SQL (included in migration script)
- [ ] If minor: Fix and redeploy
- [ ] Document incident

---

## üîß Key Files & Scripts

### Migration Scripts
- **Documentation:** `backend/migrations/01-document-current-state.sql`
- **Migration:** `backend/migrations/02-category-slugs-to-dropdown-n.sql`
- **Backup:** `backend/migrations/backups/medport_ems_pre_migration_20260119_151609.sql`

### Backup Script
- **Dual-Location Backup:** `documentation/scripts/backup-to-both-locations.sh`
  - Backs up to both `/Volumes/Acasis/` and iCloud Drive
  - Includes all databases (local, Azure dev, Azure prod)

### Implementation Plan
- **Full Plan:** `docs/active/sessions/2026-01/category_options_fix.md`

---

## üìù Quick Reference: Database Connection Details

### Dev-SWA Database
- **Host:** `traccems-dev-pgsql.postgres.database.azure.com`
- **Database:** `postgres`
- **User:** `traccems_admin`
- **Password:** `password1!`
- **Port:** `5432`
- **SSL:** Required

### Production Database
- **Host:** `traccems-prod-pgsql.postgres.database.azure.com`
- **Database:** `postgres`
- **User:** `traccems_admin`
- **Password:** `TVmedic429!`
- **Port:** `5432`
- **SSL:** Required

---

## üö® Important Notes

1. **Always create database backups before migration** - Use backup script before each environment
2. **Test migration script locally first** - Already done ‚úÖ
3. **Verify results after migration** - Run verification queries
4. **Rollback SQL is included** - In migration script comments (lines 96-149)
5. **Categories are now fixed** - Users cannot add/delete categories, only edit display names
6. **All 7 categories kept** - Including `dropdown-7` (special-needs) for checkbox configuration

---

## ‚úÖ Success Criteria

- ‚úÖ All 7 categories use fixed slugs (`dropdown-1` through `dropdown-7`)
- ‚úÖ Users cannot add new categories
- ‚úÖ Users cannot change category slugs
- ‚úÖ Users can only edit display names and order
- ‚úÖ Trip creation form loads all 6 dropdowns correctly
- ‚úÖ Special-needs checkboxes load from `dropdown-7` correctly
- ‚úÖ Trip creation process works end-to-end
- ‚úÖ Existing trips continue to work
- ‚úÖ No data loss during migration
- ‚úÖ All environments (local, dev-swa, production) are in sync

---

## üéØ Next Steps (Copy-Paste Ready)

When ready to start Phase 3:

1. **Create dev-swa database backup:**
   ```bash
   ./documentation/scripts/backup-to-both-locations.sh
   ```

2. **Connect to dev-swa database in pgAdmin:**
   - Server: `traccems-dev-pgsql`
   - Database: `postgres`
   - User: `traccems_admin`
   - Password: `password1!`

3. **Run migration script:**
   - Open Query Tool
   - Load: `backend/migrations/02-category-slugs-to-dropdown-n.sql`
   - Execute and verify results

4. **Deploy code:**
   - Merge branch to `develop`
   - Trigger dev-swa deployments
   - Test thoroughly

5. **If dev-swa is stable, proceed to production:**
   - Create production backup
   - Run migration script on production database
   - Merge `develop` to `main`
   - Deploy to production
   - Verify everything works

---

## üìã Phase 2: Add Login Tracking for Accurate Idle Account Detection

### Overview
Add `lastLogin` timestamp tracking to user tables to enable accurate detection of idle accounts based on actual login activity, rather than relying on `updatedAt` which tracks any database update.

### Prerequisites
- ‚úÖ Phase 1 (Account Creation Statistics) implemented and working
- ‚úÖ Database backup created

### Task 2.1: Database Schema Changes (pgAdmin) - **FIRST TASK FOR TOMORROW**

**IMPORTANT:** This should be the first task when starting work tomorrow.

#### Step 1: Create Database Backup
- [ ] **Create full database backup** for local dev using backup script:
  ```bash
  ./documentation/scripts/backup-to-both-locations.sh
  ```

#### Step 2: Add `lastLogin` Field to User Tables
- [ ] Open pgAdmin
- [ ] Connect to local dev database (`medport_ems` on `localhost:5432` or `5433`)
- [ ] Open Query Tool
- [ ] Execute the following SQL migration script:

```sql
-- Add lastLogin field to healthcare_users table
ALTER TABLE healthcare_users 
ADD COLUMN IF NOT EXISTS "lastLogin" TIMESTAMP(3);

-- Add lastLogin field to ems_users table
ALTER TABLE ems_users 
ADD COLUMN IF NOT EXISTS "lastLogin" TIMESTAMP(3);

-- Add lastLogin field to center_users table
ALTER TABLE center_users 
ADD COLUMN IF NOT EXISTS "lastLogin" TIMESTAMP(3);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS "healthcare_users_lastLogin_idx" ON healthcare_users("lastLogin");
CREATE INDEX IF NOT EXISTS "ems_users_lastLogin_idx" ON ems_users("lastLogin");
CREATE INDEX IF NOT EXISTS "center_users_lastLogin_idx" ON center_users("lastLogin");

-- Verify columns were added
SELECT 
    table_name,
    column_name,
    data_type
FROM information_schema.columns
WHERE table_name IN ('healthcare_users', 'ems_users', 'center_users')
AND column_name = 'lastLogin';
```

- [ ] Verify all three tables have the `lastLogin` column
- [ ] Verify indexes were created successfully

#### Step 3: Update Prisma Schema
- [ ] Update `backend/prisma/schema.prisma`:
  - Add `lastLogin DateTime?` to `HealthcareUser` model
  - Add `lastLogin DateTime?` to `EMSUser` model
  - Add `lastLogin DateTime?` to `CenterUser` model
- [ ] Run Prisma generate:
  ```bash
  cd backend && npx prisma generate
  ```

### Task 2.2: Backend Implementation

#### Step 1: Update Login Endpoints
- [ ] Update `backend/src/routes/auth.ts`:
  - [ ] Update `/api/auth/login` endpoint (CenterUser/TCC Admin login)
    - After successful login, update `lastLogin` field
  - [ ] Update `/api/auth/healthcare/login` endpoint
    - After successful login, update `lastLogin` field
  - [ ] Update `/api/auth/ems/login` endpoint
    - After successful login, update `lastLogin` field

#### Step 2: Update AuthService
- [ ] Update `backend/src/services/authService.ts`:
  - [ ] In `login()` method, add `lastLogin` update after successful authentication
  - [ ] Update all three user types (Healthcare, EMS, Admin)

#### Step 3: Add Idle Account Detection to Analytics Service
- [ ] Update `backend/src/services/analyticsService.ts`:
  - [ ] Add `getIdleAccounts()` method:
    - Accounts with no `lastLogin` in last 30 days
    - Accounts with no `lastLogin` in last 60 days
    - Accounts with no `lastLogin` in last 90 days
    - Breakdown by user type (Healthcare, EMS, Admin)
  - [ ] Add to `AccountStatistics` interface:
    ```typescript
    idleAccounts: {
      last30Days: { healthcare: number; ems: number; admin: number; total: number };
      last60Days: { healthcare: number; ems: number; admin: number; total: number };
      last90Days: { healthcare: number; ems: number; admin: number; total: number };
    }
    ```

#### Step 4: Add API Endpoint
- [ ] Update `backend/src/routes/analytics.ts`:
  - [ ] Ensure `/api/tcc/analytics/accounts` endpoint includes idle account data
  - [ ] Or add separate endpoint `/api/tcc/analytics/accounts/idle` if preferred

### Task 2.3: Frontend Implementation

#### Step 1: Update Account Statistics Interface
- [ ] Update `frontend/src/components/TCCOverview.tsx`:
  - [ ] Add `idleAccounts` to `AccountStatistics` interface
  - [ ] Update display to show idle account statistics

#### Step 2: Update Recent Activity Display
- [ ] Add idle account statistics to Recent Activity section:
  - [ ] Show accounts idle for 30+ days
  - [ ] Show accounts idle for 60+ days
  - [ ] Show accounts idle for 90+ days
  - [ ] Breakdown by user type

### Task 2.4: Testing

#### Step 1: Local Dev Testing
- [ ] Test login for each user type:
  - [ ] Healthcare user login updates `lastLogin`
  - [ ] EMS user login updates `lastLogin`
  - [ ] Admin user login updates `lastLogin`
- [ ] Verify `lastLogin` field is populated in database after login
- [ ] Test idle account detection:
  - [ ] Create test accounts with old `lastLogin` dates
  - [ ] Verify idle account counts are accurate
- [ ] Test Recent Activity display:
  - [ ] Verify idle account statistics display correctly
  - [ ] Verify account creation statistics still work

#### Step 2: Edge Cases
- [ ] Test accounts that have never logged in (`lastLogin` is NULL):
  - [ ] Should be counted as idle
- [ ] Test accounts with very old `lastLogin` dates
- [ ] Test accounts with recent `lastLogin` dates (should not appear as idle)

### Task 2.5: Migration to Dev-SWA and Production

#### Dev-SWA Migration
- [ ] Create dev-swa database backup
- [ ] Execute database migration script in pgAdmin (same as Task 2.1, Step 2)
- [ ] Deploy backend code changes
- [ ] Deploy frontend code changes
- [ ] Test in dev-swa environment

#### Production Migration
- [ ] Create production database backup
- [ ] Execute database migration script in pgAdmin (same as Task 2.1, Step 2)
- [ ] Deploy backend code changes
- [ ] Deploy frontend code changes
- [ ] Test in production environment
- [ ] Monitor for any issues

### Rollback Plan

If issues occur, rollback steps:
1. **Database Rollback:**
   ```sql
   -- Remove lastLogin columns (only if needed)
   ALTER TABLE healthcare_users DROP COLUMN IF EXISTS "lastLogin";
   ALTER TABLE ems_users DROP COLUMN IF EXISTS "lastLogin";
   ALTER TABLE center_users DROP COLUMN IF EXISTS "lastLogin";
   
   -- Remove indexes
   DROP INDEX IF EXISTS "healthcare_users_lastLogin_idx";
   DROP INDEX IF EXISTS "ems_users_lastLogin_idx";
   DROP INDEX IF EXISTS "center_users_lastLogin_idx";
   ```

2. **Code Rollback:**
   - Revert backend code changes
   - Revert frontend code changes
   - Redeploy previous version

### Success Criteria

- ‚úÖ `lastLogin` field added to all three user tables
- ‚úÖ Login endpoints update `lastLogin` on successful login
- ‚úÖ Idle account detection works accurately
- ‚úÖ Recent Activity displays idle account statistics
- ‚úÖ No performance degradation
- ‚úÖ All user types tracked correctly

---

**Last Updated:** January 20, 2026  
**Status:** Phase 1 Complete, Phase 2 Ready for Implementation (Database Changes First)
