generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  name              String?
  role              UserRole           @default(COORDINATOR)
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  routes            Route[]
  transportRequests TransportRequest[]
}

model Facility {
  id                  String             @id @default(cuid())
  name                String
  type                FacilityType
  address             String
  city                String
  state               String
  zipCode             String
  coordinates         Json?
  phone               String?
  email               String?
  operatingHours      Json?
  capabilities        Json?
  isActive            Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  distanceMatrixFrom  DistanceMatrix[]   @relation("FromFacility")
  distanceMatrixTo    DistanceMatrix[]   @relation("ToFacility")
  routeStops          RouteStop[]
  destinationRequests TransportRequest[] @relation("DestinationFacility")
  originRequests      TransportRequest[] @relation("OriginFacility")
}

model TransportRequest {
  id                     String           @id @default(cuid())
  patientId              String
  originFacilityId       String
  destinationFacilityId  String
  transportLevel         TransportLevel
  priority               Priority         @default(MEDIUM)
  status                 RequestStatus    @default(PENDING)
  specialRequirements    String?
  requestTimestamp       DateTime         @default(now())
  pickupTimestamp        DateTime?
  completionTimestamp    DateTime?
  assignedAgencyId       String?
  assignedUnitId         String?
  createdById            String
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  routeOptimizationScore Float?
  chainingOpportunities  Json?
  timeFlexibility        Int?
  revenuePotential       Float?
  routeStops             RouteStop[]
  assignedAgency         TransportAgency? @relation(fields: [assignedAgencyId], references: [id])
  assignedUnit           Unit?            @relation(fields: [assignedUnitId], references: [id])
  createdBy              User             @relation(fields: [createdById], references: [id])
  destinationFacility    Facility         @relation("DestinationFacility", fields: [destinationFacilityId], references: [id])
  originFacility         Facility         @relation("OriginFacility", fields: [originFacilityId], references: [id])
  routes                 Route[]          @relation("RouteToTransportRequest")
}

model TransportAgency {
  id                String             @id @default(cuid())
  name              String
  contactName       String?
  phone             String
  email             String
  address           String
  city              String
  state             String
  zipCode           String
  serviceArea       Json?
  operatingHours    Json?
  capabilities      Json?
  pricingStructure  Json?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  routes            Route[]
  transportRequests TransportRequest[]
  units             Unit[]
}

model Unit {
  id                String             @id @default(cuid())
  agencyId          String
  unitNumber        String
  type              TransportLevel
  capabilities      Json?
  currentStatus     UnitStatus         @default(AVAILABLE)
  currentLocation   Json?
  shiftStart        DateTime?
  shiftEnd          DateTime?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  routes            Route[]
  transportRequests TransportRequest[]
  agency            TransportAgency    @relation(fields: [agencyId], references: [id])
}

model DistanceMatrix {
  id                   String    @id @default(cuid())
  fromFacilityId       String
  toFacilityId         String
  distanceMiles        Float
  estimatedTimeMinutes Int
  trafficFactor        Float     @default(1.0)
  tolls                Float     @default(0.0)
  fuelEfficiency       Float?
  routeType            RouteType @default(FASTEST)
  lastUpdated          DateTime  @default(now())
  fromFacility         Facility  @relation("FromFacility", fields: [fromFacilityId], references: [id])
  toFacility           Facility  @relation("ToFacility", fields: [toFacilityId], references: [id])

  @@unique([fromFacilityId, toFacilityId])
}

model Route {
  id                       String                 @id @default(cuid())
  routeNumber              String                 @unique
  agencyId                 String
  assignedUnitId           String?
  status                   RouteStatus            @default(PLANNED)
  totalDistanceMiles       Float
  estimatedTimeMinutes     Int
  emptyMilesReduction      Float?
  revenueOptimizationScore Float?
  chainedTripCount         Int                    @default(0)
  estimatedRevenue         Float?
  plannedStartTime         DateTime?
  actualStartTime          DateTime?
  completionTime           DateTime?
  timeWindowStart          DateTime?
  timeWindowEnd            DateTime?
  optimizationType         RouteOptimizationType?
  milesSaved               Float?
  unitsSaved               Int?
  createdById              String
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  agency                   TransportAgency        @relation(fields: [agencyId], references: [id])
  assignedUnit             Unit?                  @relation(fields: [assignedUnitId], references: [id])
  createdBy                User                   @relation(fields: [createdById], references: [id])
  routeStops               RouteStop[]
  transportRequests        TransportRequest[]     @relation("RouteToTransportRequest")
}

model RouteStop {
  id                 String            @id @default(cuid())
  routeId            String
  stopOrder          Int
  facilityId         String
  transportRequestId String?
  stopType           StopType
  estimatedArrival   DateTime?
  actualArrival      DateTime?
  estimatedDeparture DateTime?
  actualDeparture    DateTime?
  stopDuration       Int?
  notes              String?
  facility           Facility          @relation(fields: [facilityId], references: [id])
  route              Route             @relation(fields: [routeId], references: [id])
  transportRequest   TransportRequest? @relation(fields: [transportRequestId], references: [id])

  @@unique([routeId, stopOrder])
}

enum UserRole {
  ADMIN
  COORDINATOR
  BILLING_STAFF
  TRANSPORT_AGENCY
}

enum FacilityType {
  HOSPITAL
  NURSING_HOME
  CANCER_CENTER
  REHAB_FACILITY
  URGENT_CARE
  SPECIALTY_CLINIC
}

enum TransportLevel {
  BLS
  ALS
  CCT
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RequestStatus {
  PENDING
  SCHEDULED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum UnitStatus {
  AVAILABLE
  IN_USE
  OUT_OF_SERVICE
  MAINTENANCE
}

enum RouteType {
  FASTEST
  SHORTEST
  MOST_EFFICIENT
  LOWEST_COST
  SCENIC
}

enum RouteStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OPTIMIZED
  SUGGESTED
}

enum RouteOptimizationType {
  CHAINED_TRIPS
  RETURN_TRIP
  MULTI_STOP
  GEOGRAPHIC
  TEMPORAL
  REVENUE_MAX
}

enum StopType {
  PICKUP
  DROPOFF
  REFUEL
  REST
  EQUIPMENT
  TRANSFER
}
