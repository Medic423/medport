
> tcc-backend@1.0.0 dev
> nodemon src/index.ts

[33m[nodemon] 3.1.10[39m
[33m[nodemon] to restart at any time, enter `rs`[39m
[33m[nodemon] watching path(s): *.*[39m
[33m[nodemon] watching extensions: ts,json[39m
[32m[nodemon] starting `ts-node src/index.ts`[39m
TCC_DEBUG: AuthService constructor - JWT_SECRET loaded: YES
TCC_DEBUG: JWT_SECRET value: your-super-secret-jwt-key-here
TCC_DEBUG: SMS carriers initialized: 5
TCC_DEBUG: Twilio credentials not configured
TCC_DEBUG: SendGrid API key not configured
TCC_DEBUG: FRONTEND_URL = "http://localhost:3000"
TCC_DEBUG: Cleaned frontendUrl = "http://localhost:3000"
TCC_DEBUG: Cleaned corsOrigin = "http://localhost:3000"
ðŸš€ TCC Backend server running on port 5001
ðŸ“Š Health check: http://localhost:5001/health
ðŸ” Auth endpoint: http://localhost:5001/api/auth/login
ðŸš— Trips API: http://localhost:5001/api/trips
ðŸ¥ Hospitals API: http://localhost:5001/api/tcc/hospitals
ðŸš‘ Agencies API: http://localhost:5001/api/tcc/agencies
ðŸ¢ Facilities API: http://localhost:5001/api/tcc/facilities
ðŸ“ˆ Analytics API: http://localhost:5001/api/tcc/analytics
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
TCC_DEBUG: Get trips request with query: {}
TCC_DEBUG: Authenticated user: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  name: 'Chuck Ferrell',
  userType: 'HEALTHCARE',
  facilityName: 'Ferrell Hospitals',
  agencyName: undefined,
  agencyId: undefined,
  manageMultipleLocations: true
}
TCC_DEBUG: Getting trips with filters: {
  status: undefined,
  transportLevel: undefined,
  priority: undefined,
  agencyId: undefined,
  healthcareUserId: 'cmhhu72tr000g60o5eh13qop3'
}
MULTI_LOC: Location filters - fromLocationId: undefined healthcareUserId: cmhhu72tr000g60o5eh13qop3
TCC_FILTER_DEBUG: Filtering trips for healthcareUserId: cmhhu72tr000g60o5eh13qop3
TCC_FILTER_DEBUG: Found 9 locations for user
MULTI_LOC: Filtering by user locations OR created trips: 9 locations
TCC_FILTER_DEBUG: OR filter applied: [
  {
    "fromLocationId": {
      "in": [
        "cmhhu72tt000i60o506c80rs6",
        "cmhhu72tu000k60o560ylbflb",
        "cmhhu72tu000m60o5g35qx5mh",
        "cmhhu72tv000o60o5371jeuzr",
        "cmhhu72tv000q60o5i9lc7q0j",
        "cmhhu72tw000s60o5ilatptdl",
        "cmhhu72tx000u60o54h4s3zux",
        "cmhhu72ty000w60o5gsqacwu9",
        "cmhhu72ty000y60o5hqbzbd3p"
      ]
    }
  },
  {
    "healthcareCreatedById": "cmhhu72tr000g60o5eh13qop3"
  }
]
TCC_DEBUG: Found trips: 6
TCC_DEBUG: Trips sample fields â†’ [
  {
    id: 'cmhhyugvc0000qmu72fwoba90',
    status: 'PENDING',
    assignedUnitId: null,
    assignedUnit: null
  },
  {
    id: 'cmhhynn3q0000h5a2qx80m94m',
    status: 'PENDING',
    assignedUnitId: null,
    assignedUnit: null
  },
  {
    id: 'cmhhwq4830000vva06b58p5ho',
    status: 'PENDING',
    assignedUnitId: null,
    assignedUnit: null
  }
]
TCC_FILTER_DEBUG: Trips healthcareCreatedById sample â†’ [
  {
    id: 'cmhhyugvc0000qmu72fwoba90',
    healthcareCreatedById: 'cmhhu72tr000g60o5eh13qop3'
  },
  {
    id: 'cmhhynn3q0000h5a2qx80m94m',
    healthcareCreatedById: 'cmhhu72tr000g60o5eh13qop3'
  },
  {
    id: 'cmhhwq4830000vva06b58p5ho',
    healthcareCreatedById: 'cmhhu72tr000g60o5eh13qop3'
  }
]
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Mon Valley',
  toLocation: 'UPMC Bedford Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Mon Valley
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands State College',
  toLocation: 'Altoona Regional Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands State College
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Huntingdon',
  toLocation: 'UPMC Bedford Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Huntingdon
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Elk',
  toLocation: 'Altoona Regional Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Elk
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Connellsville',
  toLocation: 'UPMC Bedford Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Connellsville
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Clearfield',
  toLocation: 'Altoona Regional Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Clearfield
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Mon Valley
TCC_DEBUG: Looking up coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Using mock coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands State College
TCC_DEBUG: Looking up coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Clearfield
TCC_DEBUG: Looking up coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Using mock coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Connellsville
TCC_DEBUG: Looking up coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Using mock coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Elk
TCC_DEBUG: Looking up coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Using mock coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Huntingdon
TCC_DEBUG: Looking up coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Using mock coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Get agency responses request with query: {}
TCC_DEBUG: Getting agency responses with filters: {
  tripId: undefined,
  agencyId: undefined,
  response: undefined,
  isSelected: undefined,
  dateFrom: undefined,
  dateTo: undefined
}
TCC_DEBUG: Found 2 agency responses in database
TCC_DEBUG: Returning 2 agency responses with trip details
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
PHASE3_DEBUG: Getting agencies for trip: cmhhyugvc0000qmu72fwoba90 Mode: GEOGRAPHIC
PHASE3_DEBUG: Trip origin location: Penn Highlands Mon Valley Coords: { lat: null, lng: null }
PHASE3_DEBUG: Found registered agencies: 5
PHASE3_DEBUG: Registered agencies: [
  { name: 'Altoona EMS', addedBy: null },
  { name: 'Bedford Ambulance Service', addedBy: null },
  { name: 'Elk County EMS', addedBy: null },
  { name: 'Duncansville EMS', addedBy: null },
  { name: 'HALAS', addedBy: null }
]
PHASE3_DEBUG: Found user agencies: 2
PHASE3_DEBUG: User agencies: [
  { name: 'Duncansville EMS', addedBy: 'cmhhu72tr000g60o5eh13qop3' },
  { name: 'HALAS', addedBy: 'cmhhu72tr000g60o5eh13qop3' }
]
PHASE3_DEBUG: Before filtering - total agencies: 5
PHASE3_DEBUG: Preferred count: 1 User agencies count: 0
PHASE3_DEBUG: Dispatch mode: GEOGRAPHIC Radius: 100
PHASE3_DEBUG: Applying GEOGRAPHIC/HYBRID filtering with radius: 100
PHASE3_DEBUG: Agency check: Altoona EMS distance: null keep: false
PHASE3_DEBUG: Agency check: Bedford Ambulance Service distance: null keep: false
PHASE3_DEBUG: Agency check: Elk County EMS distance: null keep: false
PHASE3_DEBUG: Keeping agency (user/preferred): Duncansville EMS isRegistered: true isPreferred: true
PHASE3_DEBUG: Agency check: HALAS distance: null keep: false
PHASE3_DEBUG: After filter - agencies: 5 -> 1
PHASE3_DEBUG: Returning agencies: 1 Preferred: 1 Geographic: 0
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
PHASE3_DEBUG: Getting agencies for trip: cmhhyugvc0000qmu72fwoba90 Mode: PREFERRED
PHASE3_DEBUG: Trip origin location: Penn Highlands Mon Valley Coords: { lat: null, lng: null }
PHASE3_DEBUG: Found registered agencies: 5
PHASE3_DEBUG: Registered agencies: [
  { name: 'Altoona EMS', addedBy: null },
  { name: 'Bedford Ambulance Service', addedBy: null },
  { name: 'Elk County EMS', addedBy: null },
  { name: 'Duncansville EMS', addedBy: null },
  { name: 'HALAS', addedBy: null }
]
PHASE3_DEBUG: Found user agencies: 2
PHASE3_DEBUG: User agencies: [
  { name: 'Duncansville EMS', addedBy: 'cmhhu72tr000g60o5eh13qop3' },
  { name: 'HALAS', addedBy: 'cmhhu72tr000g60o5eh13qop3' }
]
PHASE3_DEBUG: Before filtering - total agencies: 5
PHASE3_DEBUG: Preferred count: 1 User agencies count: 0
PHASE3_DEBUG: Dispatch mode: PREFERRED Radius: 100
PHASE3_DEBUG: Applying PREFERRED filtering
PHASE3_DEBUG: After PREFERRED filter - agencies: 1
PHASE3_DEBUG: Returning agencies: 1 Preferred: 1 Geographic: 0
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
TCC_DEBUG: Get trips request with query: {}
TCC_DEBUG: Authenticated user: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  name: 'Chuck Ferrell',
  userType: 'HEALTHCARE',
  facilityName: 'Ferrell Hospitals',
  agencyName: undefined,
  agencyId: undefined,
  manageMultipleLocations: true
}
TCC_DEBUG: Getting trips with filters: {
  status: undefined,
  transportLevel: undefined,
  priority: undefined,
  agencyId: undefined,
  healthcareUserId: 'cmhhu72tr000g60o5eh13qop3'
}
MULTI_LOC: Location filters - fromLocationId: undefined healthcareUserId: cmhhu72tr000g60o5eh13qop3
TCC_FILTER_DEBUG: Filtering trips for healthcareUserId: cmhhu72tr000g60o5eh13qop3
TCC_FILTER_DEBUG: Found 9 locations for user
MULTI_LOC: Filtering by user locations OR created trips: 9 locations
TCC_FILTER_DEBUG: OR filter applied: [
  {
    "fromLocationId": {
      "in": [
        "cmhhu72tt000i60o506c80rs6",
        "cmhhu72tu000k60o560ylbflb",
        "cmhhu72tu000m60o5g35qx5mh",
        "cmhhu72tv000o60o5371jeuzr",
        "cmhhu72tv000q60o5i9lc7q0j",
        "cmhhu72tw000s60o5ilatptdl",
        "cmhhu72tx000u60o54h4s3zux",
        "cmhhu72ty000w60o5gsqacwu9",
        "cmhhu72ty000y60o5hqbzbd3p"
      ]
    }
  },
  {
    "healthcareCreatedById": "cmhhu72tr000g60o5eh13qop3"
  }
]
TCC_DEBUG: Found trips: 6
TCC_DEBUG: Trips sample fields â†’ [
  {
    id: 'cmhhyugvc0000qmu72fwoba90',
    status: 'PENDING',
    assignedUnitId: null,
    assignedUnit: null
  },
  {
    id: 'cmhhynn3q0000h5a2qx80m94m',
    status: 'PENDING',
    assignedUnitId: null,
    assignedUnit: null
  },
  {
    id: 'cmhhwq4830000vva06b58p5ho',
    status: 'PENDING',
    assignedUnitId: null,
    assignedUnit: null
  }
]
TCC_FILTER_DEBUG: Trips healthcareCreatedById sample â†’ [
  {
    id: 'cmhhyugvc0000qmu72fwoba90',
    healthcareCreatedById: 'cmhhu72tr000g60o5eh13qop3'
  },
  {
    id: 'cmhhynn3q0000h5a2qx80m94m',
    healthcareCreatedById: 'cmhhu72tr000g60o5eh13qop3'
  },
  {
    id: 'cmhhwq4830000vva06b58p5ho',
    healthcareCreatedById: 'cmhhu72tr000g60o5eh13qop3'
  }
]
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Mon Valley',
  toLocation: 'UPMC Bedford Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Mon Valley
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands State College',
  toLocation: 'Altoona Regional Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands State College
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Huntingdon',
  toLocation: 'UPMC Bedford Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Huntingdon
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Elk',
  toLocation: 'Altoona Regional Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Elk
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Connellsville',
  toLocation: 'UPMC Bedford Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Connellsville
TCC_DEBUG: Calculating trip distance and time: {
  fromLocation: 'Penn Highlands Clearfield',
  toLocation: 'Altoona Regional Emergency Department'
}
TCC_DEBUG: Looking up coordinates for fromLocation: Penn Highlands Clearfield
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Mon Valley
TCC_DEBUG: Looking up coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands State College
TCC_DEBUG: Looking up coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Huntingdon
TCC_DEBUG: Looking up coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Elk
TCC_DEBUG: Looking up coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Connellsville
TCC_DEBUG: Looking up coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Using mock coordinates for fromLocation: Penn Highlands Clearfield
TCC_DEBUG: Looking up coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Using mock coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for toLocation: UPMC Bedford Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Using mock coordinates for toLocation: Altoona Regional Emergency Department
TCC_DEBUG: Calculated distance: 126.13463604926514 miles, estimated time: 252 minutes
TCC_DEBUG: Get agency responses request with query: {}
TCC_DEBUG: Getting agency responses with filters: {
  tripId: undefined,
  agencyId: undefined,
  response: undefined,
  isSelected: undefined,
  dateFrom: undefined,
  dateTo: undefined
}
TCC_DEBUG: Found 2 agency responses in database
TCC_DEBUG: Returning 2 agency responses with trip details
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
PHASE3_DEBUG: Getting agencies for trip: cmhhyugvc0000qmu72fwoba90 Mode: GEOGRAPHIC
PHASE3_DEBUG: Trip origin location: Penn Highlands Mon Valley Coords: { lat: null, lng: null }
PHASE3_DEBUG: Found registered agencies: 5
PHASE3_DEBUG: Registered agencies: [
  { name: 'Altoona EMS', addedBy: null },
  { name: 'Bedford Ambulance Service', addedBy: null },
  { name: 'Elk County EMS', addedBy: null },
  { name: 'Duncansville EMS', addedBy: null },
  { name: 'HALAS', addedBy: null }
]
PHASE3_DEBUG: Found user agencies: 2
PHASE3_DEBUG: User agencies: [
  { name: 'Duncansville EMS', addedBy: 'cmhhu72tr000g60o5eh13qop3' },
  { name: 'HALAS', addedBy: 'cmhhu72tr000g60o5eh13qop3' }
]
PHASE3_DEBUG: Before filtering - total agencies: 5
PHASE3_DEBUG: Preferred count: 1 User agencies count: 0
PHASE3_DEBUG: Dispatch mode: GEOGRAPHIC Radius: 100
PHASE3_DEBUG: Applying GEOGRAPHIC/HYBRID filtering with radius: 100
PHASE3_DEBUG: Agency check: Altoona EMS distance: null keep: false
PHASE3_DEBUG: Agency check: Bedford Ambulance Service distance: null keep: false
PHASE3_DEBUG: Agency check: Elk County EMS distance: null keep: false
PHASE3_DEBUG: Keeping agency (user/preferred): Duncansville EMS isRegistered: true isPreferred: true
PHASE3_DEBUG: Agency check: HALAS distance: null keep: false
PHASE3_DEBUG: After filter - agencies: 5 -> 1
PHASE3_DEBUG: Returning agencies: 1 Preferred: 1 Geographic: 0
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
PHASE3_DEBUG: Getting agencies for trip: cmhhyugvc0000qmu72fwoba90 Mode: PREFERRED
PHASE3_DEBUG: Trip origin location: Penn Highlands Mon Valley Coords: { lat: null, lng: null }
PHASE3_DEBUG: Found registered agencies: 5
PHASE3_DEBUG: Registered agencies: [
  { name: 'Altoona EMS', addedBy: null },
  { name: 'Bedford Ambulance Service', addedBy: null },
  { name: 'Elk County EMS', addedBy: null },
  { name: 'Duncansville EMS', addedBy: null },
  { name: 'HALAS', addedBy: null }
]
PHASE3_DEBUG: Found user agencies: 2
PHASE3_DEBUG: User agencies: [
  { name: 'Duncansville EMS', addedBy: 'cmhhu72tr000g60o5eh13qop3' },
  { name: 'HALAS', addedBy: 'cmhhu72tr000g60o5eh13qop3' }
]
PHASE3_DEBUG: Before filtering - total agencies: 5
PHASE3_DEBUG: Preferred count: 1 User agencies count: 0
PHASE3_DEBUG: Dispatch mode: PREFERRED Radius: 100
PHASE3_DEBUG: Applying PREFERRED filtering
PHASE3_DEBUG: After PREFERRED filter - agencies: 1
PHASE3_DEBUG: Returning agencies: 1 Preferred: 1 Geographic: 0
TCC_DEBUG: authenticateAdmin - authHeader: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE
TCC_DEBUG: authenticateAdmin - cookies: {
  tcc_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImNtaGh1NzJ0cjAwMGc2MG81ZWgxM3FvcDMiLCJlbWFpbCI6ImNodWNrQGZlcnJlbGxob3NwaXRhbHMuY29tIiwidXNlclR5cGUiOiJIRUFMVEhDQVJFIiwiaWF0IjoxNzYyMTAzMzMwLCJleHAiOjE3NjIxODk3MzB9.0-YXtUiB5oRp-bbz8qrXSjY-49uKmuHndkJkf2LytzE'
}
TCC_DEBUG: authenticateAdmin - token from header: eyJhbGciOiJIUzI1NiIs...
TCC_DEBUG: verifyToken called with JWT_SECRET: SET
TCC_DEBUG: Token decoded successfully: {
  id: 'cmhhu72tr000g60o5eh13qop3',
  email: 'chuck@ferrellhospitals.com',
  userType: 'HEALTHCARE'
}
PHASE3_DEBUG: Getting agencies for trip: cmhhyugvc0000qmu72fwoba90 Mode: HYBRID
PHASE3_DEBUG: Trip origin location: Penn Highlands Mon Valley Coords: { lat: null, lng: null }
PHASE3_DEBUG: Found registered agencies: 5
PHASE3_DEBUG: Registered agencies: [
  { name: 'Altoona EMS', addedBy: null },
  { name: 'Bedford Ambulance Service', addedBy: null },
  { name: 'Elk County EMS', addedBy: null },
  { name: 'Duncansville EMS', addedBy: null },
  { name: 'HALAS', addedBy: null }
]
PHASE3_DEBUG: Found user agencies: 2
PHASE3_DEBUG: User agencies: [
  { name: 'Duncansville EMS', addedBy: 'cmhhu72tr000g60o5eh13qop3' },
  { name: 'HALAS', addedBy: 'cmhhu72tr000g60o5eh13qop3' }
]
PHASE3_DEBUG: Before filtering - total agencies: 5
PHASE3_DEBUG: Preferred count: 1 User agencies count: 0
PHASE3_DEBUG: Dispatch mode: HYBRID Radius: 100
PHASE3_DEBUG: Applying GEOGRAPHIC/HYBRID filtering with radius: 100
PHASE3_DEBUG: Agency check: Altoona EMS distance: null keep: false
PHASE3_DEBUG: Agency check: Bedford Ambulance Service distance: null keep: false
PHASE3_DEBUG: Agency check: Elk County EMS distance: null keep: false
PHASE3_DEBUG: Keeping agency (user/preferred): Duncansville EMS isRegistered: true isPreferred: true
PHASE3_DEBUG: Agency check: HALAS distance: null keep: false
PHASE3_DEBUG: After filter - agencies: 5 -> 1
PHASE3_DEBUG: Returning agencies: 1 Preferred: 1 Geographic: 0
